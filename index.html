<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartBuilder AI</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¤–</text></svg>">
    <!-- Tailwind CSS CDN (é–‹ç™ºãƒ»ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ç”¨) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSSè­¦å‘Šã‚’éè¡¨ç¤º
        tailwind.config = {
            theme: {
                extend: {}
            }
        }
    </script>
    <style>
        .hidden { display: none !important; }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        .drop-zone {
            border: 3px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        /* ã‚¿ãƒ–ã‚¹ã‚¿ã‚¤ãƒ« */
        .tab-active {
            background-color: white;
            border-bottom: 3px solid #3b82f6;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ç™»éŒ²ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="authOverlay" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-md p-10 rounded-[2.5rem] shadow-2xl">
            <h2 class="text-3xl font-black mb-6 text-center">SmartBuilder AI</h2>
            
            <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
            <div class="flex gap-2 mb-6">
                <button id="loginTab" onclick="switchAuthTab('login')" 
                        class="flex-1 py-3 rounded-xl font-bold tab-active">
                    ãƒ­ã‚°ã‚¤ãƒ³
                </button>
                <button id="registerTab" onclick="switchAuthTab('register')" 
                        class="flex-1 py-3 rounded-xl font-bold bg-slate-100">
                    æ–°è¦ç™»éŒ²
                </button>
            </div>
            
            <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="loginForm">
                <input type="email" id="loginEmail" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" 
                       class="w-full p-4 mb-4 bg-slate-50 border rounded-2xl">
                <input type="password" id="loginPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" 
                       class="w-full p-4 mb-6 bg-slate-50 border rounded-2xl">
                <button onclick="login()" 
                        class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl hover:bg-slate-800 transition">
                    ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </div>
            
            <!-- ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="registerForm" class="hidden">
                <input type="email" id="registerEmail" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" 
                       class="w-full p-4 mb-4 bg-slate-50 border rounded-2xl">
                <input type="password" id="registerPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ8æ–‡å­—ä»¥ä¸Šï¼‰" 
                       class="w-full p-4 mb-4 bg-slate-50 border rounded-2xl">
                <input type="password" id="registerPasswordConfirm" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰" 
                       class="w-full p-4 mb-6 bg-slate-50 border rounded-2xl">
                <button onclick="register()" 
                        class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl hover:bg-blue-700 transition">
                    æ–°è¦ç™»éŒ²
                </button>
            </div>
        </div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl text-center max-w-sm">
            <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
            <p class="text-xl font-bold text-slate-900 mb-2" id="loadingMessage">å‡¦ç†ä¸­...</p>
            <p class="text-sm text-slate-500" id="loadingSubtext">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</p>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div id="mainContent" class="hidden container mx-auto p-8 max-w-6xl">
        
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-black">SmartBuilder AI</h1>
            <div class="flex items-center gap-4">
                <!-- ç®¡ç†è€…ç”¨ã‚¿ãƒ– -->
                <div id="adminTabs" class="hidden flex gap-2">
                    <button onclick="switchMainTab('dashboard')" id="dashboardTabBtn"
                            class="px-4 py-2 rounded-xl font-bold bg-white border">
                        é ˜åæ›¸ç®¡ç†
                    </button>
                    <button onclick="switchMainTab('admin')" id="adminTabBtn"
                            class="px-4 py-2 rounded-xl font-bold bg-slate-100">
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
                    </button>
                </div>
                
                <button onclick="loadStatus()" class="bg-white border px-4 py-2 rounded-xl text-sm font-bold">æ›´æ–°</button>
                <button onclick="logout()" class="text-red-500 font-bold">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </header>

        <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¿ãƒ– -->
        <div id="dashboardTab">
            
            <!-- ã‚µãƒ–ã‚¹ã‚¯æƒ…å ± -->
            <div id="subscriptionInfo" class="bg-white p-6 rounded-2xl shadow-sm mb-6">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>

            <!-- LINEé€£æº -->
            <div id="lineConnectionArea" class="bg-white p-6 rounded-2xl shadow-sm mb-6">
                <h3 class="text-xl font-bold mb-4">ğŸ”— LINEé€£æº</h3>
                <div id="lineConnected" class="hidden">
                    <p class="text-green-600 mb-4">âœ… LINEé€£æºæ¸ˆã¿</p>
                    <button onclick="disconnectLine()" class="bg-red-50 text-red-600 px-4 py-2 rounded-xl font-bold">
                        é€£æºã‚’è§£é™¤
                    </button>
                </div>
                <div id="lineNotConnected">
                    <p class="text-slate-600 mb-4">LINEã¨é€£æºã™ã‚‹ã¨ã€ç”»åƒã‚’é€ä¿¡ã™ã‚‹ã ã‘ã§è‡ªå‹•è§£æã§ãã¾ã™</p>
                    <button onclick="generateLineToken()" class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold">
                        ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ
                    </button>
                    <div id="lineTokenDisplay" class="hidden mt-4 p-4 bg-slate-50 rounded-xl">
                        <p class="text-sm text-slate-600 mb-2">ä»¥ä¸‹ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’LINEã§é€ä¿¡ã—ã¦ãã ã•ã„:</p>
                        <div class="flex gap-2 items-center">
                            <code id="lineToken" class="text-2xl font-mono font-bold flex-1 text-center p-3 bg-white rounded-xl">
                                --------
                            </code>
                            <button onclick="copyToken()" class="bg-blue-600 text-white px-4 py-2 rounded-xl font-bold">
                                ã‚³ãƒ”ãƒ¼
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="bg-white p-6 rounded-[2rem] shadow-sm mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">ğŸ” åº—èˆ—åæ¤œç´¢</label>
                        <input type="text" id="searchVendor" placeholder="åº—èˆ—åã‚’å…¥åŠ›" 
                               class="w-full p-3 bg-slate-50 border rounded-xl"
                               oninput="applyFilters()">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">ğŸ“… é–‹å§‹æ—¥</label>
                        <input type="date" id="filterStartDate" 
                               class="w-full p-3 bg-slate-50 border rounded-xl"
                               onchange="applyFilters()">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">ğŸ“… çµ‚äº†æ—¥</label>
                        <input type="date" id="filterEndDate" 
                               class="w-full p-3 bg-slate-50 border rounded-xl"
                               onchange="applyFilters()">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒª</label>
                        <select id="filterCategory" 
                                class="w-full p-3 bg-slate-50 border rounded-xl"
                                onchange="applyFilters()">
                            <option value="">ã™ã¹ã¦</option>
                            <option value="é£Ÿè²»">ğŸ½ï¸ é£Ÿè²»</option>
                            <option value="äº¤é€šè²»">ğŸšƒ äº¤é€šè²»</option>
                            <option value="äº‹å‹™ç”¨å“">ğŸ¢ äº‹å‹™ç”¨å“</option>
                            <option value="å…‰ç†±è²»">ğŸ’¡ å…‰ç†±è²»</option>
                            <option value="é€šä¿¡è²»">ğŸ“± é€šä¿¡è²»</option>
                            <option value="åŒ»ç™‚è²»">ğŸ¥ åŒ»ç™‚è²»</option>
                            <option value="äº¤éš›è²»">ğŸ‰ äº¤éš›è²»</option>
                            <option value="ãã®ä»–">ğŸ“¦ ãã®ä»–</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button onclick="clearFilters()" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-xl text-sm font-bold hover:bg-slate-300 transition">
                        ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                    </button>
                </div>
            </div>

            <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ -->
            <div class="bg-white p-8 rounded-[2rem] shadow-sm mb-6 drop-zone" id="dropZone">
                <div class="text-center">
                    <p class="text-2xl font-bold mb-2">ğŸ“„ é ˜åæ›¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
                    <p class="text-slate-500 mb-6">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                    <input type="file" id="fileInput" accept="image/*,.pdf" multiple class="hidden">
                    <button onclick="document.getElementById('fileInput').click()" 
                            class="bg-blue-600 text-white font-bold px-8 py-4 rounded-2xl hover:bg-blue-700 transition">
                        ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                    </button>
                    <p class="text-xs text-slate-400 mt-4">å¯¾å¿œå½¢å¼: JPG, PNG, PDF / è¤‡æ•°é¸æŠå¯èƒ½</p>
                </div>
            </div>

            <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ&ä¸€æ‹¬å‰Šé™¤ -->
            <div class="flex gap-4 mb-6">
                <button onclick="toggleBulkDeleteMode()" id="bulkDeleteToggle" 
                        class="bg-white border px-6 py-3 rounded-xl font-bold hover:bg-slate-50 transition">
                    ä¸€æ‹¬å‰Šé™¤
                </button>
                <button onclick="exportCSV()" class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-green-700 transition">
                    ğŸ“Š CSV
                </button>
                <button onclick="exportExcel()" class="bg-emerald-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-emerald-700 transition">
                    ğŸ“— Excel
                </button>
                <button onclick="exportPDF()" class="bg-red-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-red-700 transition">
                    ğŸ“• PDF
                </button>
            </div>

            <!-- ä¸€æ‹¬å‰Šé™¤ãƒœã‚¿ãƒ³ -->
            <div id="bulkDeleteActions" class="hidden mb-6 p-4 bg-red-50 rounded-xl flex justify-between items-center">
                <p class="font-bold text-red-600"><span id="selectedCount">0</span>ä»¶é¸æŠä¸­</p>
                <div class="flex gap-2">
                    <button onclick="selectAll()" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-blue-700 transition">
                        å…¨ã¦é¸æŠ
                    </button>
                    <button onclick="deselectAll()" class="bg-slate-400 text-white px-6 py-2 rounded-xl font-bold hover:bg-slate-500 transition">
                        é¸æŠè§£é™¤
                    </button>
                    <button onclick="bulkDelete()" class="bg-red-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-red-700 transition">
                        é¸æŠã—ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
                    </button>
                    <button onclick="toggleBulkDeleteMode()" class="bg-slate-200 text-slate-700 px-6 py-2 rounded-xl font-bold hover:bg-slate-300 transition">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                </div>
            </div>

            <!-- ãƒ¬ã‚³ãƒ¼ãƒ‰ä¸€è¦§ -->
            <div id="recordsList" class="space-y-4">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ç®¡ç†è€…ã‚¿ãƒ– -->
        <div id="adminTab" class="hidden">
            <div class="bg-white p-6 rounded-2xl shadow-sm mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h2>
                    <button onclick="showCreateUserModal()" 
                            class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 transition">
                        + æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ 
                    </button>
                </div>
                
                <div id="usersList" class="space-y-4">
                    <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] shadow-2xl max-w-md w-full p-8" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold mb-6">ãƒ¬ã‚³ãƒ¼ãƒ‰ç·¨é›†</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">æ—¥ä»˜</label>
                    <input type="date" id="editDate" class="w-full p-3 bg-slate-50 border rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">åº—èˆ—å</label>
                    <input type="text" id="editVendor" class="w-full p-3 bg-slate-50 border rounded-xl" placeholder="åº—èˆ—åã‚’å…¥åŠ›">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">é‡‘é¡ï¼ˆå††ï¼‰</label>
                    <input type="number" id="editAmount" class="w-full p-3 bg-slate-50 border rounded-xl" placeholder="é‡‘é¡ã‚’å…¥åŠ›">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">ã‚«ãƒ†ã‚´ãƒª</label>
                    <select id="editCategory" class="w-full p-3 bg-slate-50 border rounded-xl">
                        <option value="é£Ÿè²»">ğŸ½ï¸ é£Ÿè²»</option>
                        <option value="äº¤é€šè²»">ğŸšƒ äº¤é€šè²»</option>
                        <option value="äº‹å‹™ç”¨å“">ğŸ¢ äº‹å‹™ç”¨å“</option>
                        <option value="å…‰ç†±è²»">ğŸ’¡ å…‰ç†±è²»</option>
                        <option value="é€šä¿¡è²»">ğŸ“± é€šä¿¡è²»</option>
                        <option value="åŒ»ç™‚è²»">ğŸ¥ åŒ»ç™‚è²»</option>
                        <option value="äº¤éš›è²»">ğŸ‰ äº¤éš›è²»</option>
                        <option value="ãã®ä»–">ğŸ“¦ ãã®ä»–</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="saveEdit()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">
                    ä¿å­˜
                </button>
                <button onclick="closeEditModal()" class="flex-1 bg-slate-200 text-slate-700 font-bold py-3 rounded-xl hover:bg-slate-300 transition">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            </div>
        </div>
    </div>

    <!-- ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4">
        <button id="closeModalBtn" onclick="closeImageModal()" 
                class="absolute top-4 right-4 text-white text-4xl font-bold hover:text-gray-300 z-10">
            Ã—
        </button>
        <div id="pageInfo" class="absolute top-4 left-4 text-white text-lg font-bold bg-black bg-opacity-50 px-4 py-2 rounded-xl">
            1 / 1
        </div>
        <img id="modalImage" src="" class="max-w-full max-h-full object-contain">
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="createUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] shadow-2xl max-w-md w-full p-8">
            <h2 class="text-2xl font-bold mb-6">æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="newUserEmail" class="w-full p-3 bg-slate-50 border rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="newUserPassword" class="w-full p-3 bg-slate-50 border rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">ãƒ—ãƒ©ãƒ³</label>
                    <select id="newUserPlan" class="w-full p-3 bg-slate-50 border rounded-xl">
                        <option value="free">Free (10ä»¶/æœˆ)</option>
                        <option value="premium">Premium (100ä»¶/æœˆ)</option>
                        <option value="enterprise">Enterprise (1000ä»¶/æœˆ)</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="createUser()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">
                    ä½œæˆ
                </button>
                <button onclick="closeCreateUserModal()" class="flex-1 bg-slate-200 text-slate-700 font-bold py-3 rounded-xl hover:bg-slate-300 transition">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let TOKEN = localStorage.getItem('token') || '';
        let USER_ROLE = localStorage.getItem('role') || 'user';
        let isBulkDeleteMode = false;
        let selectedRecords = new Set();
        let selectedFiles = [];
        let editingRecordId = null;
        let allRecords = [];
        let currentImageIndex = 0;
        let currentImages = [];

        // ã‚«ãƒ†ã‚´ãƒªã‚¢ã‚¤ã‚³ãƒ³
        const categoryIcons = {
            'é£Ÿè²»': 'ğŸ½ï¸',
            'äº¤é€šè²»': 'ğŸšƒ',
            'äº‹å‹™ç”¨å“': 'ğŸ¢',
            'å…‰ç†±è²»': 'ğŸ’¡',
            'é€šä¿¡è²»': 'ğŸ“±',
            'åŒ»ç™‚è²»': 'ğŸ¥',
            'äº¤éš›è²»': 'ğŸ‰',
            'ãã®ä»–': 'ğŸ“¦'
        };

        // èªè¨¼ãƒã‚§ãƒƒã‚¯ä»˜ãFetch
        async function authFetch(url, options = {}) {
            const headers = {
                'Authorization': `Bearer ${TOKEN}`,
                ...options.headers
            };
            return fetch(url, { ...options, headers });
        }

        // èªè¨¼ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchAuthTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            if (tab === 'login') {
                loginTab.classList.add('tab-active', 'bg-white');
                loginTab.classList.remove('bg-slate-100');
                registerTab.classList.remove('tab-active', 'bg-white');
                registerTab.classList.add('bg-slate-100');
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                registerTab.classList.add('tab-active', 'bg-white');
                registerTab.classList.remove('bg-slate-100');
                loginTab.classList.remove('tab-active', 'bg-white');
                loginTab.classList.add('bg-slate-100');
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        }

        // ãƒ­ã‚°ã‚¤ãƒ³
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('email', email);
                formData.append('password', password);

                const res = await fetch('/login', {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    const data = await res.json();
                    TOKEN = data.access_token;
                    USER_ROLE = data.role || 'user';
                    localStorage.setItem('token', TOKEN);
                    localStorage.setItem('role', USER_ROLE);
                    
                    document.getElementById('authOverlay').classList.add('hidden');
                    document.getElementById('mainContent').classList.remove('hidden');
                    
                    // ç®¡ç†è€…ã®å ´åˆã€ç®¡ç†è€…ã‚¿ãƒ–ã‚’è¡¨ç¤º
                    if (USER_ROLE === 'admin') {
                        document.getElementById('adminTabs').classList.remove('hidden');
                    }
                    
                    await loadStatus();
                } else {
                    alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }
            } catch (e) {
                console.error(e);
                alert('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // æ–°è¦ç™»éŒ²
        async function register() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

            if (!email || !password || !passwordConfirm) {
                alert('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (password.length < 8) {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (password !== passwordConfirm) {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('email', email);
                formData.append('password', password);

                const res = await fetch('/register', {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    const data = await res.json();
                    TOKEN = data.access_token;
                    USER_ROLE = 'user';
                    localStorage.setItem('token', TOKEN);
                    localStorage.setItem('role', USER_ROLE);
                    
                    alert('ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                    
                    document.getElementById('authOverlay').classList.add('hidden');
                    document.getElementById('mainContent').classList.remove('hidden');
                    
                    await loadStatus();
                } else {
                    const error = await res.json();
                    alert(`ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.detail}`);
                }
            } catch (e) {
                console.error(e);
                alert('ç™»éŒ²ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logout() {
            TOKEN = '';
            USER_ROLE = 'user';
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            document.getElementById('authOverlay').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
        }

        // ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchMainTab(tab) {
            const dashboardTab = document.getElementById('dashboardTab');
            const adminTab = document.getElementById('adminTab');
            const dashboardBtn = document.getElementById('dashboardTabBtn');
            const adminBtn = document.getElementById('adminTabBtn');

            if (tab === 'dashboard') {
                dashboardTab.classList.remove('hidden');
                adminTab.classList.add('hidden');
                dashboardBtn.classList.add('bg-white');
                dashboardBtn.classList.remove('bg-slate-100');
                adminBtn.classList.remove('bg-white');
                adminBtn.classList.add('bg-slate-100');
            } else {
                dashboardTab.classList.add('hidden');
                adminTab.classList.remove('hidden');
                dashboardBtn.classList.remove('bg-white');
                dashboardBtn.classList.add('bg-slate-100');
                adminBtn.classList.add('bg-white');
                adminBtn.classList.remove('bg-slate-100');
                loadUsers();
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—
        async function loadStatus() {
            try {
                const res = await authFetch('/api/status');
                const data = await res.json();
                allRecords = data.records.reverse();
                
                // ã‚µãƒ–ã‚¹ã‚¯æƒ…å ±ã‚’è¡¨ç¤º
                displaySubscriptionInfo(data.subscription);
                
                // LINEé€£æºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
                checkLineStatus();
                
                // ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
                applyFilters();
            } catch (e) {
                console.error(e);
            }
        }

        // ã‚µãƒ–ã‚¹ã‚¯æƒ…å ±ã‚’è¡¨ç¤º
        function displaySubscriptionInfo(subscription) {
            const planNames = {
                'free': 'ç„¡æ–™ãƒ—ãƒ©ãƒ³',
                'premium': 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³',
                'enterprise': 'ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºãƒ—ãƒ©ãƒ³',
                'unlimited': 'ç„¡åˆ¶é™ãƒ—ãƒ©ãƒ³'
            };

            const plan = subscription.plan || 'free';
            const planName = planNames[plan] || plan;
            const used = subscription.used || 0;
            const limit = subscription.limit || 10;
            const percentage = Math.min((used / limit) * 100, 100);

            let upgradeButton = '';
            if (plan === 'free') {
                upgradeButton = `
                    <button onclick="alert('ãƒ—ãƒ©ãƒ³ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’ã”å¸Œæœ›ã®å ´åˆã¯ã€ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚')" 
                            class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 transition">
                        ãƒ—ãƒ©ãƒ³ã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
                    </button>
                `;
            }

            document.getElementById('subscriptionInfo').innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="flex-1">
                        <p class="text-sm text-slate-500">ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³</p>
                        <p class="text-2xl font-bold mb-2">${planName}</p>
                        <p class="text-sm text-slate-600 mb-2">ä½¿ç”¨çŠ¶æ³: ${used} / ${limit}ä»¶</p>
                        <div class="w-full bg-slate-200 rounded-full h-3">
                            <div class="bg-blue-600 h-3 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                    <div>
                        ${upgradeButton}
                    </div>
                </div>
            `;
        }

        // LINEé€£æºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
        async function checkLineStatus() {
            try {
                const res = await authFetch('/api/line-status');
                const data = await res.json();

                if (data.connected) {
                    document.getElementById('lineConnected').classList.remove('hidden');
                    document.getElementById('lineNotConnected').classList.add('hidden');
                } else {
                    document.getElementById('lineConnected').classList.add('hidden');
                    document.getElementById('lineNotConnected').classList.remove('hidden');
                }
            } catch (e) {
                console.error(e);
            }
        }

        // LINEãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
        async function generateLineToken() {
            try {
                const res = await authFetch('/api/line-token');
                const data = await res.json();

                document.getElementById('lineToken').textContent = data.token;
                document.getElementById('lineTokenDisplay').classList.remove('hidden');
            } catch (e) {
                console.error(e);
                alert('ãƒˆãƒ¼ã‚¯ãƒ³ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚³ãƒ”ãƒ¼
        function copyToken() {
            const token = document.getElementById('lineToken').textContent;
            navigator.clipboard.writeText(token);
            alert('ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        }

        // LINEé€£æºè§£é™¤
        async function disconnectLine() {
            if (!confirm('LINEé€£æºã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                const res = await authFetch('/api/line-disconnect', { method: 'POST' });
                if (res.ok) {
                    alert('LINEé€£æºã‚’è§£é™¤ã—ã¾ã—ãŸ');
                    await checkLineStatus();
                }
            } catch (e) {
                console.error(e);
                alert('é€£æºè§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        function applyFilters() {
            const searchVendor = document.getElementById('searchVendor').value.toLowerCase();
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const category = document.getElementById('filterCategory').value;

            let filtered = allRecords.filter(r => {
                if (searchVendor && !r.vendor_name.toLowerCase().includes(searchVendor)) {
                    return false;
                }
                if (startDate && r.date < startDate) {
                    return false;
                }
                if (endDate && r.date > endDate) {
                    return false;
                }
                if (category && r.category !== category) {
                    return false;
                }
                return true;
            });

            renderRecords(filtered);
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢
        function clearFilters() {
            document.getElementById('searchVendor').value = '';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('filterCategory').value = '';
            renderRecords(allRecords);
        }

        // ãƒ¬ã‚³ãƒ¼ãƒ‰è¡¨ç¤º
        function renderRecords(records) {
            const list = document.getElementById('recordsList');
            list.innerHTML = records.map(r => {
                const displayUrl = (r.pdf_images && r.pdf_images.length > 0) ? r.pdf_images[0] : r.image_url;
                const allImages = (r.pdf_images && r.pdf_images.length > 0) ? r.pdf_images : [r.image_url];
                const categoryIcon = categoryIcons[r.category] || 'ğŸ“¦';

                return `
                <div class="bg-white p-6 rounded-2xl shadow-sm flex justify-between items-center">
                    <div class="flex gap-4 items-center">
                        ${isBulkDeleteMode ? `
                            <input type="checkbox" 
                                   id="check-${r.id}" 
                                   ${selectedRecords.has(r.id) ? 'checked' : ''}
                                   onchange="toggleRecordSelection('${r.id}')"
                                   class="w-5 h-5 cursor-pointer">
                        ` : ''}
                        <div class="relative">
                            <img src="${displayUrl}" 
                                 class="w-12 h-12 object-cover rounded-lg cursor-pointer hover:opacity-80 transition" 
                                 onclick='openImageModal(${JSON.stringify(allImages)})'
                                 title="ã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§è¡¨ç¤º">
                            ${r.is_pdf ? '<span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs px-1 rounded">PDF</span>' : ''}
                        </div>
                        <div>
                            <p class="text-xs text-slate-400">${r.date}</p>
                            <p class="font-bold">${r.vendor_name}</p>
                            <p class="text-xs text-slate-500">${categoryIcon} ${r.category || 'ãã®ä»–'}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <p class="text-xl font-black text-blue-600">Â¥${r.total_amount.toLocaleString()}</p>
                        ${!isBulkDeleteMode ? `
                            <button onclick='openEditModal(${JSON.stringify(r)})' 
                                    class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-sm font-bold hover:bg-blue-100 transition"
                                    title="ç·¨é›†">
                                âœï¸
                            </button>
                            <button onclick="deleteRecord('${r.id}', '${r.vendor_name}')" 
                                    class="bg-red-50 text-red-600 px-4 py-2 rounded-xl text-sm font-bold hover:bg-red-100 transition"
                                    title="å‰Šé™¤">
                                ğŸ—‘ï¸
                            </button>
                        ` : ''}
                    </div>
                </div>
            `}).join('');
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        function showLoading(message, subtext) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingSubtext').textContent = subtext;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        document.getElementById('fileInput').addEventListener('change', handleFiles);

        function handleFiles(e) {
            selectedFiles = Array.from(e.target.files);
            if (selectedFiles.length > 0) {
                uploadFiles();
            }
        }

        async function uploadFiles() {
            if (selectedFiles.length === 0) return;

            showLoading(`${selectedFiles.length}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...`, 'AIè§£æã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™');

            const formData = new FormData();
            selectedFiles.forEach(file => {
                formData.append('files', file);
            });

            try {
                const res = await authFetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const contentType = res.headers.get('content-type');
                let responseData;

                if (contentType && contentType.includes('application/json')) {
                    responseData = await res.json();
                } else {
                    responseData = await res.text();
                }

                hideLoading();

                if (res.ok) {
                    const summary = responseData.summary;
                    alert(`âœ… ${summary.success}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã—ã¾ã—ãŸ\n${summary.errors > 0 ? `âŒ ${summary.errors}ä»¶ã®ã‚¨ãƒ©ãƒ¼` : ''}`);
                    await loadStatus();
                } else {
                    alert(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${responseData.detail || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
                }
            } catch (e) {
                hideLoading();
                console.error(e);
                alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            } finally {
                selectedFiles = [];
                document.getElementById('fileInput').value = '';
            }
        }

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
        const dropZone = document.getElementById('dropZone');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            selectedFiles = Array.from(e.dataTransfer.files);
            uploadFiles();
        });

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
        function openEditModal(record) {
            editingRecordId = record.id;
            document.getElementById('editDate').value = record.date || '';
            document.getElementById('editVendor').value = record.vendor_name || '';
            document.getElementById('editAmount').value = record.total_amount || '';
            document.getElementById('editCategory').value = record.category || 'ãã®ä»–';
            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            editingRecordId = null;
            document.getElementById('editModal').classList.add('hidden');
        }

        async function saveEdit() {
            if (!editingRecordId) return;

            const date = document.getElementById('editDate').value;
            const vendor = document.getElementById('editVendor').value;
            const amount = document.getElementById('editAmount').value;
            const category = document.getElementById('editCategory').value;

            if (!date || !vendor || !amount) {
                alert('æ—¥ä»˜ã€åº—èˆ—åã€é‡‘é¡ã¯å¿…é ˆé …ç›®ã§ã™');
                return;
            }

            showLoading('æ›´æ–°ä¸­...', '');

            try {
                const res = await authFetch(`/api/records/${editingRecordId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: date,
                        vendor_name: vendor,
                        total_amount: parseInt(amount),
                        category: category
                    })
                });

                if (res.ok) {
                    alert('æ›´æ–°ã—ã¾ã—ãŸ');
                    closeEditModal();
                    await loadStatus();
                } else {
                    const error = await res.json();
                    alert(`æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.detail}`);
                }
            } catch (e) {
                console.error(e);
                alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                hideLoading();
            }
        }

        // å‰Šé™¤
        async function deleteRecord(recordId, vendorName) {
            if (!confirm(`ã€Œ${vendorName}ã€ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“`)) {
                return;
            }

            showLoading('å‰Šé™¤ä¸­...', '');

            try {
                const res = await authFetch(`/api/records/${recordId}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    await loadStatus();
                    alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                } else {
                    const error = await res.json();
                    alert(`å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.detail}`);
                }
            } catch (e) {
                console.error(e);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                hideLoading();
            }
        }

        // ä¸€æ‹¬å‰Šé™¤
        function toggleBulkDeleteMode() {
            isBulkDeleteMode = !isBulkDeleteMode;
            selectedRecords.clear();

            const toggle = document.getElementById('bulkDeleteToggle');
            const actions = document.getElementById('bulkDeleteActions');

            if (isBulkDeleteMode) {
                toggle.classList.add('bg-red-600', 'text-white');
                toggle.textContent = 'ä¸€æ‹¬å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ ON';
                actions.classList.remove('hidden');
            } else {
                toggle.classList.remove('bg-red-600', 'text-white');
                toggle.textContent = 'ä¸€æ‹¬å‰Šé™¤';
                actions.classList.add('hidden');
            }

            renderRecords(allRecords);
        }

        function toggleRecordSelection(recordId) {
            if (selectedRecords.has(recordId)) {
                selectedRecords.delete(recordId);
            } else {
                selectedRecords.add(recordId);
            }
            document.getElementById('selectedCount').textContent = selectedRecords.size;
        }

        // å…¨ã¦é¸æŠ
        function selectAll() {
            allRecords.forEach(record => {
                selectedRecords.add(record.id);
                const checkbox = document.getElementById(`check-${record.id}`);
                if (checkbox) checkbox.checked = true;
            });
            document.getElementById('selectedCount').textContent = selectedRecords.size;
        }

        // é¸æŠè§£é™¤
        function deselectAll() {
            selectedRecords.clear();
            allRecords.forEach(record => {
                const checkbox = document.getElementById(`check-${record.id}`);
                if (checkbox) checkbox.checked = false;
            });
            document.getElementById('selectedCount').textContent = 0;
        }

        async function bulkDelete() {
            if (selectedRecords.size === 0) {
                alert('å‰Šé™¤ã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm(`${selectedRecords.size}ä»¶ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“`)) {
                return;
            }

            showLoading('å‰Šé™¤ä¸­...', '');

            try {
                const res = await authFetch('/api/records/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        record_ids: Array.from(selectedRecords)
                    })
                });

                if (res.ok) {
                    const data = await res.json();
                    alert(data.message);
                    selectedRecords.clear();
                    toggleBulkDeleteMode();
                    await loadStatus();
                } else {
                    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (e) {
                console.error(e);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                hideLoading();
            }
        }

        // ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ«
        function openImageModal(images) {
            currentImages = images;
            currentImageIndex = 0;
            showImageAtIndex(0);
            document.getElementById('imageModal').classList.remove('hidden');
        }

        function showImageAtIndex(index) {
            document.getElementById('modalImage').src = currentImages[index];
            document.getElementById('pageInfo').textContent = `${index + 1} / ${currentImages.length}`;
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
        }

        // ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ
        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('imageModal');
            if (!modal.classList.contains('hidden')) {
                if (e.key === 'Escape') {
                    closeImageModal();
                } else if (e.key === 'ArrowLeft' && currentImageIndex > 0) {
                    currentImageIndex--;
                    showImageAtIndex(currentImageIndex);
                } else if (e.key === 'ArrowRight' && currentImageIndex < currentImages.length - 1) {
                    currentImageIndex++;
                    showImageAtIndex(currentImageIndex);
                }
            }
        });

        // ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('imageModal');
            modal.addEventListener('click', function(e) {
                const clickedElement = e.target;
                const isImage = clickedElement.tagName === 'IMG';
                const isCloseButton = clickedElement.closest('#closeModalBtn');
                const isPageInfo = clickedElement.closest('#pageInfo');

                if (!isImage && !isCloseButton && !isPageInfo) {
                    closeImageModal();
                }
            });
        });

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        async function exportCSV() {
            window.open(`/api/export/csv?token=${TOKEN}`, '_blank');
        }

        async function exportExcel() {
            window.open(`/api/export/excel?token=${TOKEN}`, '_blank');
        }

        async function exportPDF() {
            window.open(`/api/export/pdf?token=${TOKEN}`, '_blank');
        }

        // ç®¡ç†è€…æ©Ÿèƒ½
        async function loadUsers() {
            try {
                const res = await authFetch('/admin/users');
                const data = await res.json();

                const usersList = document.getElementById('usersList');
                usersList.innerHTML = data.users.map(user => {
                    const sub = user.subscription || {};
                    const planName = {
                        'free': 'ç„¡æ–™',
                        'premium': 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ',
                        'enterprise': 'ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚º',
                        'unlimited': 'ç„¡åˆ¶é™'
                    }[sub.plan] || sub.plan;

                    return `
                    <div class="border rounded-xl p-4 flex justify-between items-center">
                        <div>
                            <p class="font-bold">${user.email}</p>
                            <p class="text-sm text-slate-600">ãƒ—ãƒ©ãƒ³: ${planName} (${sub.used || 0}/${sub.limit || 0}ä»¶)</p>
                            ${user.line_user_id ? '<p class="text-xs text-green-600">âœ… LINEé€£æºæ¸ˆã¿</p>' : ''}
                        </div>
                        <div class="flex gap-2">
                            ${user.id !== 'admin' ? `
                                <button onclick="changePlan('${user.id}')" 
                                        class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-sm font-bold">
                                    ãƒ—ãƒ©ãƒ³å¤‰æ›´
                                </button>
                                <button onclick="deleteUser('${user.id}', '${user.email}')" 
                                        class="bg-red-50 text-red-600 px-4 py-2 rounded-xl text-sm font-bold">
                                    å‰Šé™¤
                                </button>
                            ` : '<span class="text-xs text-slate-400">ç®¡ç†è€…</span>'}
                        </div>
                    </div>
                    `;
                }).join('');
            } catch (e) {
                console.error(e);
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function showCreateUserModal() {
            document.getElementById('createUserModal').classList.remove('hidden');
        }

        function closeCreateUserModal() {
            document.getElementById('createUserModal').classList.add('hidden');
        }

        async function createUser() {
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const plan = document.getElementById('newUserPlan').value;

            if (!email || !password) {
                alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                const res = await authFetch('/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, plan })
                });

                if (res.ok) {
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ');
                    closeCreateUserModal();
                    loadUsers();
                } else {
                    const error = await res.json();
                    alert(`ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.detail}`);
                }
            } catch (e) {
                console.error(e);
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        async function changePlan(userId) {
            const plan = prompt('ãƒ—ãƒ©ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„:\nfree / premium / enterprise');
            if (!plan || !['free', 'premium', 'enterprise'].includes(plan)) {
                alert('ç„¡åŠ¹ãªãƒ—ãƒ©ãƒ³ã§ã™');
                return;
            }

            try {
                const res = await authFetch(`/admin/users/${userId}/subscription`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ plan })
                });

                if (res.ok) {
                    alert('ãƒ—ãƒ©ãƒ³ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
                    loadUsers();
                } else {
                    alert('ãƒ—ãƒ©ãƒ³å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (e) {
                console.error(e);
                alert('ãƒ—ãƒ©ãƒ³å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        async function deleteUser(userId, email) {
            if (!confirm(`${email} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“`)) {
                return;
            }

            try {
                const res = await authFetch(`/admin/users/${userId}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    loadUsers();
                } else {
                    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (e) {
                console.error(e);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', () => {
            if (TOKEN) {
                document.getElementById('authOverlay').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                
                if (USER_ROLE === 'admin') {
                    document.getElementById('adminTabs').classList.remove('hidden');
                }
                
                loadStatus();
            }
        });
    </script>
</body>
</html>